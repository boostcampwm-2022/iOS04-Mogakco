#!/bin/sh
# written by Noah
LINT=$(which swiftlint)

if [[ -e "${LINT}" ]]; then
	echo "ğŸš€  SwiftLint ì‹œì‘..."
	echo "ğŸ”  lint ì ìš© ê²½ë¡œ: $(pwd)"
else
	echo "SwiftLintê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤, ê³µì‹ë¬¸ì„œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. ğŸŒ https://github.com/realm/SwiftLint"
	exit 1
fi

normalfiles=$(git diff --stat --cached)
targets=$(git diff --stat --cached --diff-filter=d --name-only $(git for-each-ref --format='%(upstream:short)' $(git symbolic-ref -q HEAD)) | grep -F ".swift")

if [ -n "$normalfiles" -a -z "$targets" ]; then
  printf "âœ¨ ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤ğŸ‘ ğŸ‘ ğŸ‘\n"
  exit 0

elif [ -z "${normalfiles}" ]; then
  printf "ğŸ·ï¸  Staging Area íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
  printf "\n âœ” git addë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”:)"
  exit 1

elif [ -z "$targets" ]; then
  printf "ğŸ·ï¸  Staging Area swift íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
  printf "\n âœ” git addë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”:)"
  exit 1
fi

# lint rule ì •ì˜ íŒŒì¼
RESULT=$($LINT lint --quiet --config .swiftlint.yml)

if [ "$RESULT" == '' ]; then
	printf "âœ¨  SwiftLint ì ìš©ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!! ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤:)\n"
else
	echo ""
	printf "âœ” SwiftLint Failed ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n"
  while read -r line; do
    FILEPATH=$(echo $line | cut -d : -f 1)
    L=$(echo $line | cut -d : -f 2)
    C=$(echo $line | cut -d : -f 3)
    TYPE=$(echo $line | cut -d : -f 4 | cut -c 2-)
    MESSAGE=$(echo $line | cut -d : -f 5 | cut -c 2-)
    DESCRIPTION=$(echo $line | cut -d : -f 6 | cut -c 2-)
    if [ $TYPE == 'warning' ]; then
      printf "\n ğŸš§  $TYPE\n"
      # warning íƒ€ì…ì€ ì˜¤ë¥˜ë©”ì‹œì§€ë§Œ í‘œì‹œí•˜ê³  ì»¤ë°‹ì„ í—ˆìš©í•˜ê³  ì‹¶ë‹¤ë©´ line 40~42 ì£¼ì„ í•´ì œ.
      # printf "    $FILEPATH:$L:$C\n"
      # printf "    ğŸ“Œ  $MESSAGE: - $DESCRIPTION\n"
      # exit 0
    elif [ $TYPE == 'error' ]; then
      printf "\n ğŸš¨  $TYPE\n"
    fi
    printf "    âœ” $FILEPATH:$L:$C\n"
    printf "    ğŸ“Œ $MESSAGE: - $DESCRIPTION\n"
  done <<< "$RESULT"

  printf "\n ğŸš‘  ì»¤ë°‹ì‹¤íŒ¨!! Swiftlint ruleì— ë§ê²Œ ì½”ë“œë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”:)\n"
  exit 1
fi
